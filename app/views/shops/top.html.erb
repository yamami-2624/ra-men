<div class="main-container">
  <div class="container">
      <div class="row">
        <div class="col-xs-7 col-xs-offset-4">
          <h1>ラーメンを食べに行こう！！</h1>
        </div>
      </div>
      <br>
      <br>
      <div class="row">
          <div class="col-xs-3 col-xs-offset-1">
            <div id="search">
              <h2>検索する</h2>
          		<tbody>
          			<tr>
          				<td>
                  <h4>店名から選ぶ</h4>
                  <%= form_tag(search_path,:method => 'get') do %>
                    <%= text_field_tag :search %>
                    <%= submit_tag '検索', :name => nil %>
                  <% end %>
  						    </td>
                <tr>
                <br>
                  <h4>場所から選ぶ</h4>
                  <input id="address" type="textbox">
                  <input type="button" value="検索" onclick="codeAddress()">
  					    </tr>
                <tr>
                <br>
                <br>
                  <h4>現在地から選ぶ</h4>
                  <button id="getcurrentlocation">
                    <%= image_tag "move.png", class: "move" %> 移動する
                  </button>
                </tr>
                <br>
                <br>
                <tr>
                  <h4>ランキングから選ぶ</h4>
                  <%= link_to  weekly_ranking_path, class: "rank_btn" do %>
                   <%= image_tag "king.png", class: "king" %> 移動する
                  <% end %>
                </tr>
  				    </tbody>
            </div>
          </div>
          <div class="col-xs-7">
            <div id='map'></div>
          </div>
      </div>
  </div>
</div>


<script>
let mapInstance
let map;
// let marker = []; // マーカーを複数表示させたいので、配列化

function initMap(){
      geocoder = new google.maps.Geocoder()

      map = new google.maps.Map(document.getElementById('map'), {
          center: {lat: 35.68123620000001, lng:139.7671248},
          zoom: 12,
      });
    <% @shops.each do |s| %>
          (function(){
          var contentString = "住所：<%= s.address %>"

          var marker = new google.maps.Marker({
              position:{lat: <%= s.latitude %>, lng: <%= s.longitude %>},
              map: map,
            });

          var　infoWindow = new google.maps.InfoWindow({ // 吹き出しの追加
              content: '<%= link_to s.name, shop_path(s) %>' // 吹き出しに表示する内容
            });

              marker.addListener('click', function() { // マーカーをクリックしたとき
              infoWindow.open(map, marker); // 吹き出しの表示
            });
          })();
    <% end %>


    document.getElementById('getcurrentlocation').onclick = function() {
      geoLocationInit();
    }

    function geoLocationInit() {
      if (navigator.geolocation) {
          navigator.geolocation.getCurrentPosition(success, fail);
        } else {
          createMap(pyrmont);
      }
    }

   // success
   function success(position) {
     var currentLat = position.coords.latitude;
     var currentLng = position.coords.longitude;

     var pyrmont = new google.maps.LatLng(currentLat,currentLng);

     createMap(pyrmont)

     CurrentPositionMarker(pyrmont);
    }

    // fail
    function fail(pyrmont) {
      createMap(pyrmont);
    }


    function createMap(pyrmont) {

      map = new google.maps.Map(document.getElementById('map'), {
        center: pyrmont,
        zoom: 16
      });
      <% @shops.each do |s| %>
          (function(){
          var contentString = "住所：<%= s.address %>"

          var marker = new google.maps.Marker({
              position:{lat: <%= s.latitude %>, lng: <%= s.longitude %>},
              map: map,
              title: contentString
            });

              infoWindow = new google.maps.InfoWindow({ // 吹き出しの追加
              content: '<%= link_to s.name, shop_path(s) %>' // 吹き出しに表示する内容
            });

              marker.addListener('click', function() { // マーカーをクリックしたとき
              infoWindow.open(map, marker); // 吹き出しの表示
            });
          })();
      <% end %>
    }


    // 現在地のアイコンを表示 出ない
    function CurrentPositionMarker(pyrmont) {
        var image = 'move.png';
        var marker = new google.maps.Marker({
                position: pyrmont,
                map: map,
                icon: image
            });
        marker.setMap(map);
    }
    }


    function codeAddress(){
      // 入力を取得
      let inputAddress = document.getElementById('address').value;

      // geocodingしたあとmapを移動
      geocoder.geocode( { 'address': inputAddress}, function(results, status) {
        if (status == 'OK') {
    　　　　　　　　　　　　// map.setCenterで地図が移動
          map.setCenter(results[0].geometry.location);
    　　　　　　　　　　　　// google.maps.MarkerでGoogleMap上の指定位置にマーカが立つ
         // var marker = new google.maps.Marker({
         //      map: map,
         //      position: results[0].geometry.location
         //  });
        } else {
          alert('Geocode was not successful for the following reason: ' + status);
        }
      });
        <% @shops.each do |s| %>
            (function(){
            var contentString = "住所：<%= s.address %>"

            var marker = new google.maps.Marker({
                position:{lat: <%= s.latitude %>, lng: <%= s.longitude %>},
                map: map,
                title: contentString
              });

                infoWindow = new google.maps.InfoWindow({ // 吹き出しの追加
                content: '<%= link_to s.name, shop_path(s) %>' // 吹き出しに表示する内容
              });

                marker.addListener('click', function() { // マーカーをクリックしたとき
                infoWindow.open(map, marker); // 吹き出しの表示
              });
            })();
        <% end %>
       }


</script>
<script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyDpE1N1jyqshzxRVMQyqRgD2MXCILhif74&callback=initMap" async defer></script>

<style>
	#map {
		width: 800px;
    height: 700px;
	}

  #search{

  }
</style>